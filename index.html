<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Insight Topics â€” Random Generator</title>
  <style>
    body { font-family: -apple-system, system-ui, Arial, sans-serif; margin: 0; background:#0b0b0f; color:#f4f4f6; }
    header { padding: 18px 16px; position: sticky; top: 0; background: rgba(11,11,15,.92); backdrop-filter: blur(10px); border-bottom: 1px solid #222; }
    h1 { margin: 0 0 10px; font-size: 18px; font-weight: 700; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input[type="search"]{
      flex: 1; min-width: 240px; padding: 10px 12px; border-radius: 10px;
      border: 1px solid #2a2a33; background: #12121a; color: #f4f4f6;
      outline: none;
    }
    button{
      padding: 10px 12px; border-radius: 10px; border: 1px solid #2a2a33;
      background: #171723; color: #f4f4f6; cursor: pointer;
    }
    button:hover{ background:#1c1c2b; }
    main { padding: 18px 16px 80px; max-width: 980px; margin: 0 auto; }
    .card { background:#12121a; border:1px solid #242433; border-radius:14px; padding:14px; margin-top:14px; }
    .topic-title { font-size: 26px; margin: 0; }
    .meta { color:#b7b7c8; font-size: 13px; margin-top: 6px; }
    a { color:#9fd0ff; }
    .pill { display:inline-block; padding: 4px 10px; border: 1px solid #2a2a33; border-radius: 999px; font-size: 12px; color:#cfcfe6; margin-right:8px; }
    .list button { width:100%; text-align:left; padding: 10px 12px; margin-top:8px; }
    .muted { color:#b7b7c8; }
  </style>
</head>
<body>
<header>
  <h1>Insight on the Scriptures â€” Random Topic</h1>
  <div class="row">
    <input id="q" type="search" placeholder="Search topicsâ€¦ (e.g., Jehovah, Abaddon, Faith)" autocomplete="off" />
    <button id="randomBtn">ðŸŽ² Random</button>
    <button id="openBtn" disabled>Open on JW.org</button>
  </div>
  <div class="meta">Uses your <code>it_E_topics.json</code> (topics + JW.org finder links).</div>
</header>

<main>
  <div id="status" class="muted">Loading topicsâ€¦</div>

  <div id="topicCard" class="card" style="display:none;">
    <div id="pills" class="meta"></div>
    <h2 id="title" class="topic-title"></h2>
    <div id="links" class="meta"></div>
  </div>

  <div id="resultsCard" class="card" style="display:none;">
    <div class="meta">Search results (click to open)</div>
    <div id="results" class="list"></div>
  </div>
</main>

<script>
  const DATA_FILE = "it_E_topics.json";

  let topics = [];
  let currentTopic = null;

  const $ = (id) => document.getElementById(id);
  const statusEl = $("status");
  const topicCard = $("topicCard");
  const titleEl = $("title");
  const linksEl = $("links");
  const pillsEl = $("pills");
  const resultsCard = $("resultsCard");
  const resultsEl = $("results");
  const qEl = $("q");
  const openBtn = $("openBtn");
  const randomBtn = $("randomBtn");

  function normalize(s){
    return (s || "")
      .toLowerCase()
      .replace(/[â€™â€˜]/g,"'")
      .replace(/\s+/g," ")
      .trim();
  }

  function pickRandom(){
    if (!topics.length) return;
    const t = topics[Math.floor(Math.random() * topics.length)];
    showTopic(t);
  }

  function showTopic(t){
    currentTopic = t;
    const name = t.display_topic || t.topic || "(Untitled)";
    titleEl.textContent = name;

    // Pills
    const docCount = (t.documents || []).length;
    pillsEl.innerHTML = `
      <span class="pill">Topic ID: ${t.topic_id}</span>
      <span class="pill">Docs: ${docCount}</span>
    `;

    // Links list (some topics have multiple docs)
    const docs = t.documents || [];
    if (!docs.length) {
      linksEl.innerHTML = `<span class="muted">No linked documents found for this topic.</span>`;
      openBtn.disabled = true;
      openBtn.onclick = null;
    } else {
      const primary = docs[0];
      const url = primary.jw_org_finder_url || "";
      openBtn.disabled = !url;
      openBtn.onclick = () => url && window.open(url, "_blank", "noopener,noreferrer");

      const items = docs.map((d, i) => {
        const u = d.jw_org_finder_url || "#";
        const title = d.title || `Document ${i+1}`;
        const pages = Array.isArray(d.page_range) ? ` â€¢ pages ${d.page_range[0]}â€“${d.page_range[1]}` : "";
        return `<div style="margin-top:8px;">
          <a href="${u}" target="_blank" rel="noopener noreferrer">${escapeHtml(title)}</a>
          <span class="muted">â€¢ docid ${d.meps_document_id ?? "?"}${pages}</span>
        </div>`;
      }).join("");

      linksEl.innerHTML = items;
    }

    // hide search results
    resultsCard.style.display = "none";
    topicCard.style.display = "block";
    statusEl.style.display = "none";

    // shareable hash
    location.hash = `#topic=${encodeURIComponent(String(t.topic_id))}`;
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function showResults(list){
    resultsEl.innerHTML = "";
    if (!list.length) {
      resultsEl.innerHTML = `<div class="muted">No matches.</div>`;
      resultsCard.style.display = "block";
      return;
    }
    for (const t of list) {
      const btn = document.createElement("button");
      btn.textContent = t.display_topic || t.topic;
      btn.addEventListener("click", () => showTopic(t));
      resultsEl.appendChild(btn);
    }
    resultsCard.style.display = "block";
  }

  function search(q){
    const nq = normalize(q);
    if (!nq) { resultsCard.style.display = "none"; return; }
    const matches = topics
      .filter(t => normalize(t.display_topic || t.topic).includes(nq))
      .slice(0, 40);
    showResults(matches);
  }

  async function load(){
    try {
      const res = await fetch(DATA_FILE, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const db = await res.json();
      topics = db.topics || [];
      statusEl.textContent = `Loaded ${topics.length} topics.`;

      // open from URL hash if present
      const m = (location.hash || "").match(/topic=([^&]+)/);
      if (m) {
        const id = Number(decodeURIComponent(m[1]));
        const t = topics.find(x => x.topic_id === id);
        if (t) showTopic(t);
        else pickRandom();
      } else {
        pickRandom();
      }
    } catch (e) {
      console.error(e);
      statusEl.textContent = "Could not load it_E_topics.json. Make sure youâ€™re running a local server (not double-clicking the HTML).";
    }
  }

  qEl.addEventListener("input", (e) => search(e.target.value));
  qEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      const nq = normalize(qEl.value);
      if (!nq) return;
      const first = topics.find(t => normalize(t.display_topic || t.topic).includes(nq));
      if (first) showTopic(first);
    }
  });

  randomBtn.addEventListener("click", pickRandom);

  // Keyboard shortcuts: / focus search, R random
  document.addEventListener("keydown", (e)=>{
    if (e.key === "/" && document.activeElement !== qEl) { e.preventDefault(); qEl.focus(); }
    if (e.key.toLowerCase() === "r" && document.activeElement !== qEl) pickRandom();
  });

  load();
</script>
</body>
</html>
