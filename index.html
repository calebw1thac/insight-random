<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0d12" />
  <title>Insight Random Topic</title>

  <style>
    :root {
      --bg: #0b0d12;
      --panel: #141826;
      --text: #eef1ff;
      --muted: rgba(238,241,255,.72);
      --border: rgba(255,255,255,.10);
      --accent: rgba(122,162,255,.22);
      --accentBorder: rgba(122,162,255,.40);
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* One single scroll container for iOS reliability */
    .app {
      height: 100dvh; /* iOS 16+ correct viewport */
      display: flex;
      flex-direction: column;
      background: radial-gradient(1200px 600px at 50% 0%, #1a2550, var(--bg));
    }

    header {
      position: sticky; /* safer than fixed on iOS */
      top: 0;
      z-index: 10;
      padding: calc(12px + env(safe-area-inset-top)) 14px 12px;
      backdrop-filter: blur(12px);
      background: rgba(11,13,18,.70);
      border-bottom: 1px solid var(--border);
    }

    .headerRow {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .titleWrap { display:flex; flex-direction:column; gap:4px; }
    .title { font-size: 16px; font-weight: 800; letter-spacing:.2px; }
    .sub { font-size: 12px; color: var(--muted); }

    .btnRow { display:flex; gap:10px; align-items:center; }
    button {
      appearance: none;
      border: 1px solid var(--accentBorder);
      background: var(--accent);
      color: var(--text);
      border-radius: 14px;
      padding: 11px 14px;
      font-size: 14px;
      font-weight: 750;
      cursor: pointer;
      user-select: none;
    }
    button:active { transform: scale(.98); }

    .pill {
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(238,241,255,.85);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      white-space: nowrap;
    }

    /* This is the ONLY scroller */
    .scroll {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 14px;
      padding-bottom: calc(18px + env(safe-area-inset-bottom));
    }

    .card {
      width: min(900px, 100%);
      margin: 0 auto;
      background: linear-gradient(180deg, rgba(20,24,38,.92), rgba(20,24,38,.72));
      border: 1px solid var(--border);
      border-radius: 20px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      padding: 18px;
    }

    .topicTitle {
      font-size: clamp(22px, 3.2vw, 34px);
      line-height: 1.15;
      font-weight: 900;
      margin: 6px 0 10px;
    }

    .meta {
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }

    .para {
      font-size: 16px;
      line-height: 1.65;
      margin: 0 0 14px;
      color: rgba(238,241,255,.92);
    }

    .errorBox {
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: 14px;
      padding: 12px;
      color: rgba(238,241,255,.92);
      font-size: 14px;
      line-height: 1.5;
      margin-top: 10px;
      word-break: break-word;
    }

    .footerHint {
      width: min(900px, 100%);
      margin: 10px auto 0;
      color: var(--muted);
      font-size: 12px;
      display:flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      padding: 0 4px;
    }

    code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>

<body>
  <div class="app" id="app">
    <header>
      <div class="headerRow">
        <div class="titleWrap">
          <div class="title">Insight â€“ Random Topic</div>
          <div class="sub">Swipe anywhere to randomize â€¢ Scroll normally to read</div>
        </div>

        <div class="btnRow">
          <span class="pill" id="statusPill">Loadingâ€¦</span>
          <button id="randomBtn">ðŸŽ² Random</button>
        </div>
      </div>
    </header>

    <div class="scroll" id="scroll">
      <div class="card">
        <div class="topicTitle" id="topicTitle">Loadingâ€¦</div>
        <div class="meta" id="meta"></div>
        <div id="content"></div>
      </div>

      <div class="footerHint" id="footerHint">
        <div>Tip: Add to Home Screen for an app-like feel.</div>
        <div id="countHint">Topics: â€¦</div>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const FILENAME = "insight_volume1_topics_PARAGRAPHS_CLEAN.json"; // make sure this matches your file

    // ===== STATE =====
    let topics = [];
    let lastIndex = -1;

    // ===== UI HELPERS =====
    const el = (id) => document.getElementById(id);

    function setStatus(text) {
      el("statusPill").textContent = text;
    }

    function showError(message) {
      setStatus("Error");
      el("topicTitle").textContent = "Couldnâ€™t load topics";
      el("meta").textContent = "";
      el("content").innerHTML = `
        <div class="errorBox">
          <b>Error:</b> ${escapeHtml(message)}<br><br>
          <b>Fix checklist:</b><br>
          â€¢ Open this page over <code>http(s)</code> (not <code>file://</code>)<br>
          â€¢ Put <code>${FILENAME}</code> in the same folder as <code>index.html</code><br>
          â€¢ Verify the JSON opens directly in your browser at <code>.../${FILENAME}</code>
        </div>
      `;
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // ===== DATA LOADING (with fallbacks) =====
    async function fetchWithFallback(paths) {
      let lastErr = null;
      for (const p of paths) {
        try {
          const res = await fetch(p, { cache: "no-store" });
          if (!res.ok) throw new Error(`${p} â†’ HTTP ${res.status}`);
          const data = await res.json();
          if (!Array.isArray(data) || !data.length) throw new Error(`${p} â†’ JSON loaded but empty/invalid`);
          return data;
        } catch (e) {
          lastErr = e;
        }
      }
      throw lastErr || new Error("Unknown fetch error");
    }

    async function loadTopics() {
      setStatus("Loadingâ€¦");
      el("topicTitle").textContent = "Loadingâ€¦";
      el("content").innerHTML = "";

      // Works for local servers and most hosts.
      // Also tries /REPO/ for GitHub Pages.
      const repo = location.pathname.split("/").filter(Boolean)[0];
      const candidates = [
        `./${FILENAME}`,
        `/${FILENAME}`,
        repo ? `/${repo}/${FILENAME}` : null
      ].filter(Boolean);

      try {
        topics = await fetchWithFallback(candidates);
        el("countHint").textContent = `Topics: ${topics.length}`;
        setStatus("Ready");
        randomTopic();
      } catch (e) {
        showError(e.message || String(e));
      }
    }

    // ===== RENDER =====
    function randomTopic() {
      if (!topics.length) return;

      let idx;
      do {
        idx = Math.floor(Math.random() * topics.length);
      } while (idx === lastIndex && topics.length > 1);

      lastIndex = idx;
      const t = topics[idx];

      el("topicTitle").textContent = t.title;
      el("meta").textContent =
        `Volume ${t.volume} â€¢ PDF pages ${t.pdf_page_start}â€“${t.pdf_page_end}`;

      const content = el("content");
      content.innerHTML = "";

      (t.paragraphs || []).forEach(p => {
        const div = document.createElement("p");
        div.className = "para";
        div.textContent = p;
        content.appendChild(div);
      });

      // Scroll to top of the ONLY scroll container (safe)
      el("scroll").scrollTo({ top: 0, behavior: "instant" });
    }

    // ===== EVENTS =====
    el("randomBtn").addEventListener("click", randomTopic);

    // Swipe anywhere on screen to randomize (doesn't interfere with normal scrolling)
    let startY = null;
    window.addEventListener("touchstart", (e) => {
      if (!e.touches || !e.touches[0]) return;
      startY = e.touches[0].clientY;
    }, { passive: true });

    window.addEventListener("touchend", (e) => {
      if (startY == null) return;
      const endY = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0].clientY : startY;
      const dy = endY - startY;
      startY = null;

      // A deliberate swipe (not a small scroll)
      if (Math.abs(dy) > 60) randomTopic();
    }, { passive: true });

    // Keyboard for desktop testing
    window.addEventListener("keydown", (e) => {
      if ([" ", "ArrowDown", "ArrowUp", "PageDown", "PageUp"].includes(e.key)) {
        e.preventDefault();
        randomTopic();
      }
    });

    // Start
    loadTopics();
  </script>
</body>
</html>
