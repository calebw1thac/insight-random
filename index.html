<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Insight Random Topic Generator</title>
  <style>
    body { font-family: -apple-system, system-ui, Arial, sans-serif; margin: 0; background: #0b0b0f; color: #f4f4f6; }
    header { padding: 18px 16px; position: sticky; top: 0; background: rgba(11,11,15,.9); backdrop-filter: blur(10px); border-bottom: 1px solid #222; }
    h1 { margin: 0 0 10px; font-size: 18px; font-weight: 700; letter-spacing: .2px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    input[type="search"]{
      flex: 1; min-width: 240px; padding: 10px 12px; border-radius: 10px;
      border: 1px solid #2a2a33; background: #12121a; color: #f4f4f6;
      outline: none;
    }
    button{
      padding: 10px 12px; border-radius: 10px; border: 1px solid #2a2a33;
      background: #171723; color: #f4f4f6; cursor: pointer;
    }
    button:hover{ background:#1c1c2b; }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    main { padding: 18px 16px 80px; max-width: 980px; margin: 0 auto; }
    .meta { color: #b7b7c8; font-size: 13px; margin-top: 6px; }
    .card { background: #12121a; border: 1px solid #242433; border-radius: 14px; padding: 14px; margin-top: 14px; }
    .topic-title { font-size: 22px; margin: 0; }
    .pill { display:inline-block; padding: 4px 10px; border: 1px solid #2a2a33; border-radius: 999px; font-size: 12px; color:#cfcfe6; margin-right:8px; }
    .section { margin-top: 14px; }
    .section h3 { margin: 0 0 8px; font-size: 14px; letter-spacing: .2px; color: #d9d9ff; }
    .para { line-height: 1.45; margin: 8px 0; color:#f1f1ff; }
    .muted { color:#b7b7c8; }
    .toast { position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%);
      background:#1a1a27; border:1px solid #2a2a33; color:#fff;
      padding:10px 12px; border-radius: 999px; display:none; }
    .list { margin-top: 10px; }
    .list button { width:100%; text-align:left; padding: 10px 12px; margin-top:8px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; padding: 2px 6px; border:1px solid #2a2a33; border-radius:6px; color:#cfcfe6; }
  </style>
</head>
<body>
<header>
  <h1>Insight Random Topic Generator</h1>
  <div class="row">
    <input id="q" type="search" placeholder="Search topics‚Ä¶ (e.g., Jehovah, Abaddon, Faith)" autocomplete="off" />
    <button id="randomBtn" title="Random topic (R)">üé≤ Random</button>
    <button id="prevBtn" title="Back (‚Üê)" disabled>‚Üê Back</button>
    <button id="nextBtn" title="Forward (‚Üí)" disabled>Forward ‚Üí</button>
    <button id="copyBtn" title="Copy share link">üîó Copy link</button>
  </div>
  <div class="meta">
    Tips: <span class="kbd">R</span> random ‚Ä¢ <span class="kbd">/</span> focus search ‚Ä¢ <span class="kbd">Enter</span> open top result
  </div>
</header>

<main>
  <div id="status" class="muted">Loading data‚Ä¶</div>

  <div id="resultCard" class="card" style="display:none;">
    <div class="meta" id="metaLine"></div>
    <h2 class="topic-title" id="topicTitle"></h2>
    <div id="content"></div>
  </div>

  <div id="searchResults" class="card" style="display:none;">
    <div class="meta">Search results</div>
    <div id="resultsList" class="list"></div>
  </div>
</main>

<div id="toast" class="toast"></div>

<script>
  const DATA_FILE = "insight_topics_5053.json";

  let DB = null;             // full JSON
  let topics = [];           // DB.topics
  let topicsById = new Map();
  let currentId = null;

  // history navigation
  let historyIds = [];
  let historyPos = -1;

  const $ = (id) => document.getElementById(id);
  const statusEl = $("status");
  const cardEl = $("resultCard");
  const metaEl = $("metaLine");
  const titleEl = $("topicTitle");
  const contentEl = $("content");
  const resultsWrap = $("searchResults");
  const resultsList = $("resultsList");
  const qEl = $("q");
  const prevBtn = $("prevBtn");
  const nextBtn = $("nextBtn");
  const randomBtn = $("randomBtn");
  const copyBtn = $("copyBtn");

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    setTimeout(()=> t.style.display="none", 1600);
  }

  function normalize(s){
    return (s || "")
      .toLowerCase()
      .replace(/[‚Äô‚Äò]/g,"'")
      .replace(/\s+/g," ")
      .trim();
  }

  function setNavButtons(){
    prevBtn.disabled = !(historyPos > 0);
    nextBtn.disabled = !(historyPos >= 0 && historyPos < historyIds.length - 1);
  }

  function pushHistory(id){
    // if user goes back then picks a new topic, truncate forward history
    if (historyPos < historyIds.length - 1) {
      historyIds = historyIds.slice(0, historyPos + 1);
    }
    historyIds.push(id);
    historyPos = historyIds.length - 1;
    setNavButtons();
  }

  function renderTopic(id, {push=true} = {}){
    const t = topicsById.get(id);
    if (!t) return;

    currentId = id;
    if (push) pushHistory(id);

    // update URL hash for share links
    location.hash = `#topic=${encodeURIComponent(String(id))}`;

    // hide search results
    resultsWrap.style.display = "none";

    // header/meta
    titleEl.textContent = t.topic || "(Untitled)";
    const vols = (t.volumes && t.volumes.length) ? `Vol: ${t.volumes.join(", ")}` : "Vol: ‚Äî";
    const secCount = Array.isArray(t.sections) ? t.sections.length : 0;
    metaEl.innerHTML = `
      <span class="pill">Topic ID: ${t.topic_id}</span>
      <span class="pill">${vols}</span>
      <span class="pill">Sections: ${secCount}</span>
    `;

    // content
    contentEl.innerHTML = "";
    const sections = Array.isArray(t.sections) ? t.sections : [];

    if (!sections.length) {
      const div = document.createElement("div");
      div.className = "section";
      div.innerHTML = `<p class="para muted">No extracted text for this topic (some entries are index/redirect topics). Try another topic or search related ones.</p>`;
      contentEl.appendChild(div);
    } else {
      for (const s of sections) {
        const wrap = document.createElement("div");
        wrap.className = "section";

        if (s.type === "subheading" && s.heading) {
          wrap.innerHTML += `<h3>${escapeHtml(s.heading)}</h3>`;
        } else if (s.type === "qa" && s.question) {
          wrap.innerHTML += `<h3>Q: ${escapeHtml(s.question)}</h3>`;
        }

        const paras = (s.type === "qa") ? (s.answer || []) : (s.paragraphs || []);
        for (const p of paras) {
          const para = document.createElement("p");
          para.className = "para";
          para.textContent = p;
          wrap.appendChild(para);
        }

        contentEl.appendChild(wrap);
      }
    }

    statusEl.style.display = "none";
    cardEl.style.display = "block";
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function showResults(items){
    resultsList.innerHTML = "";
    if (!items.length) {
      resultsList.innerHTML = `<div class="muted">No matches.</div>`;
      resultsWrap.style.display = "block";
      return;
    }
    for (const t of items) {
      const btn = document.createElement("button");
      btn.textContent = t.topic;
      btn.addEventListener("click", ()=> renderTopic(t.topic_id, {push:true}));
      resultsList.appendChild(btn);
    }
    resultsWrap.style.display = "block";
  }

  function search(q){
    const nq = normalize(q);
    if (!nq) {
      resultsWrap.style.display = "none";
      return;
    }
    // simple contains search; fast enough for ~5k topics
    const matches = topics
      .filter(t => normalize(t.topic).includes(nq))
      .slice(0, 30);
    showResults(matches);
  }

  function randomTopic(){
    const idx = Math.floor(Math.random() * topics.length);
    const t = topics[idx];
    renderTopic(t.topic_id, {push:true});
  }

  async function load(){
    try {
      const res = await fetch(DATA_FILE, {cache:"no-store"});
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      DB = await res.json();
      topics = DB.topics || [];
      topicsById = new Map(topics.map(t => [t.topic_id, t]));
      statusEl.textContent = `Loaded ${topics.length} topics.`;

      // If URL has a topic hash, open it; otherwise pick a random one
      const m = (location.hash || "").match(/topic=([^&]+)/);
      if (m) {
        const id = Number(decodeURIComponent(m[1]));
        if (topicsById.has(id)) renderTopic(id, {push:true});
        else randomTopic();
      } else {
        randomTopic();
      }
    } catch (e) {
      statusEl.textContent = "Failed to load JSON. Make sure you're running a local server (not opening the file directly).";
      console.error(e);
    }
  }

  // UI events
  qEl.addEventListener("input", (e)=> search(e.target.value));
  qEl.addEventListener("keydown", (e)=>{
    if (e.key === "Enter") {
      const nq = normalize(qEl.value);
      if (!nq) return;
      const first = topics.find(t => normalize(t.topic).includes(nq));
      if (first) renderTopic(first.topic_id, {push:true});
    }
  });

  randomBtn.addEventListener("click", randomTopic);

  prevBtn.addEventListener("click", ()=>{
    if (historyPos > 0) {
      historyPos -= 1;
      setNavButtons();
      renderTopic(historyIds[historyPos], {push:false});
    }
  });

  nextBtn.addEventListener("click", ()=>{
    if (historyPos < historyIds.length - 1) {
      historyPos += 1;
      setNavButtons();
      renderTopic(historyIds[historyPos], {push:false});
    }
  });

  copyBtn.addEventListener("click", async ()=>{
    const url = location.href;
    try {
      await navigator.clipboard.writeText(url);
      toast("Link copied!");
    } catch {
      // fallback
      prompt("Copy this link:", url);
    }
  });

  // Keyboard shortcuts
  document.addEventListener("keydown", (e)=>{
    if (e.key === "/" && document.activeElement !== qEl) {
      e.preventDefault(); qEl.focus();
    }
    if (e.key.toLowerCase() === "r" && document.activeElement !== qEl) randomTopic();
    if (e.key === "ArrowLeft" && !prevBtn.disabled) prevBtn.click();
    if (e.key === "ArrowRight" && !nextBtn.disabled) nextBtn.click();
  });

  load();
</script>
</body>
</html>
